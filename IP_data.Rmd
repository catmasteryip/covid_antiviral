---
title: "R Notebook"
output: html_notebook
---

# import libraries

```{r}
library(survival)
library(broom)
library(ipw)
library(survey)
library(comorbidity)
library(WeightIt)
```


# 2022-04-26: episode death info is missing from hosp files; 
# please refer to data_import.Rmd for IP data import 
# check drug names (optional)

```{r}
unique(ip$`Drug Name`)[grepl("ACETYL", unique(ip$`Drug Name`))]
```

# dissociate drug use and ip data (unique by HN number)

```{r}
# specify icd9 code column index
diag_cols = 35:49

df_ip = ip %>%
  select(-`Drug Name`) %>%
  distinct() %>%
  # exclude pregnancy
  mutate(pregnancy = ifelse(if_any(diag_cols, ~between(., "630", "679.99")), T, F),
         pregnancy = ifelse(is.na(pregnancy), F, pregnancy)) %>%
  filter(!pregnancy) %>%
  select(-pregnancy)
```

# medication status of IP epsiodes with IP data only

```{r}
ip_drug_use = ip %>%
  # exclude pregnancy
  mutate(pregnancy = ifelse(if_any(diag_cols, ~between(., "630", "679.99")), T, F),
         pregnancy = ifelse(is.na(pregnancy), F, pregnancy)) %>%
  filter(!pregnancy) %>%
  select(-pregnancy) %>% 
  select(`HN Number`, `Drug Name`) 

medIPdf = 
  ip_drug_use %>%
  impute_meds() %>%
  select(-`Drug Name`) %>%
  distinct()

# aggregate by HN Number, get 1 if possible
medIPdf = aggregate(medIPdf, by = list(medIPdf[, "HN Number"]), FUN = "max") %>%
  select(-Group.1)

```

# comorbs, change to comorbidity package

```{r}
# specify icd9 code column index
diag_cols = 35:49

ip_diag = df_ip %>% 
  select(`HN Number`, diag_cols) 
diag_cols = diag_cols - 33 
ip_diag = ip_diag %>%
  pivot_longer(cols = diag_cols, names_to = "diagnosis", values_to = "code") %>%
  drop_na() %>%
  group_by(`HN Number`) %>%
  distinct() %>%
  ungroup() %>%
  mutate(id = 1:n())

# write icd9 long format data to .xlsx
writexl::write_xlsx(ip_diag, path = "./ip_icd9.xlsx")

# comorbidity
charlson = comorbidity::comorbidity(x = as.data.frame(ip_diag), 
                                   id = "id", 
                                   code = "code", 
                                   map = "charlson_icd9_quan", 
                                   assign0 = T)
ip_diag = left_join(ip_diag, charlson) %>% 
  select(-diagnosis, -id, -code) 
ip_diag = aggregate(x = ip_diag, 
          by = list(ip_diag$`HN Number`), 
          FUN = "max") %>%
  select(-Group.1) %>%
  mutate_at(2:length(colnames(.)), ~replace_na(., 0))

```

# identification dataframe of IP patients' first admissions only

```{r}
ip_first_by_patient_id = df_ip %>%
  select(`Reference Key`, `HN Number`, `Admission Date (yyyy-mm-dd)`) %>%
  group_by(`Reference Key`) %>%
  slice(which.min(ymd(`Admission Date (yyyy-mm-dd)`))) %>%
  ungroup()
```

# IP data joins

```{r}
# hhttps://cran.r-project.org/web/packages/tableone/vignettes/smd.html#:~:text=The%20standardized%20(mean)%20difference%20is,and%20after%20propensity%20score%20matching.
library(tableone)
ip_tab1_df = df_ip %>%
  mutate(`Admission Age (Year) (episode based)` = as.numeric(`Admission Age (Year) (episode based)`),
         ) %>%
  select(`Reference Key`, `HN Number`,`Admission Date (yyyy-mm-dd)`,
         `Admission Age (Year) (episode based)`, Sex) %>%
  filter(`HN Number` %in% ip_first_by_patient_id$`HN Number`) %>%
  # left_join ip_diag to df_ip by HN Number
  left_join(., ip_diag, by = "HN Number") 

# combine with OP meds status (incomplete)
# 1. match by reference key &
# 2. appointment date <= (first) admission date
medOPdf_shortlist = ip_tab1_df %>%
  select(`Reference Key`, `Admission Date (yyyy-mm-dd)`) %>%
  left_join(medOPdf, by = "Reference Key") %>%
  filter(ymd(`Appointment Date (yyyy-mm-dd)`) <= ymd(`Admission Date (yyyy-mm-dd)`)) %>%
  select(c("Reference Key", "paxlovid", "aspirin", "ace_inhibitors", "beta_blockers", "calcium_channel_blockers", "statins", "molnupiravir"))


medIPdf_shortlist = ip_tab1_df %>%
  select(`Reference Key`, `HN Number`) %>%
  left_join(medIPdf, by = "HN Number")

common_cols = intersect(colnames(medOPdf_shortlist), colnames(medIPdf_shortlist))
medIOPdf = bind_rows(medOPdf_shortlist %>% select(common_cols), 
                     medIPdf_shortlist %>% select(common_cols))

# aggregate medIOPdf by reference key
medIOPdf = aggregate(medIOPdf, by = list(medIOPdf[, "Reference Key"]), FUN = "max") %>%
  select(-Group.1) %>%
  # as.factor binary cols
  mutate_at(2:length(colnames(medIOPdf)), factor)

# left join IOP meds status 
ip_tab1_df = ip_tab1_df %>%
  left_join(medIOPdf, by = "Reference Key")

# # optional, left join IP meds data only 
# ip_tab1_df = ip_tab1_df %>%
#   left_join(medIPdf_shortlist)

# write excel by patient data
writexl::write_xlsx(ip_tab1_dfholder, path = "./ip_df.xlsx")
```

# table 1 descriptive/SMD

```{r}
# as.factor cateogorical cols
ip_tab1_dfholder = ip_tab1_df %>%
  select(-`Reference Key`, -`HN Number`, -`Admission Date (yyyy-mm-dd)`) %>%
  mutate(across(2:length(colnames(ip_tab1_dfholder)), factor))

ip_tab1_p = CreateTableOne(data = ip_tab1_dfholder, strata = "paxlovid")
ip_tab1_p
ip_tab1_m = CreateTableOne(data = ip_tab1_dfholder, strata = "molnupiravir")
ip_tab1_m
```

# 28d mortality and length of stay

```{r}
# subselect relevant cols
ip_death_los = df_ip %>%
  select(
         # keys
         `Reference Key`, `HN Number`, 
         # death information, death if discharge status == death, discharge date becomes death date
         `Admission Date (yyyy-mm-dd)`, `Discharge Date (yyyy-mm-dd)`,  `Discharge Status`, 
         # length of stay LOS in days
         `Length of Stay`
         ) %>%
  filter(ymd(`Admission Date (yyyy-mm-dd)`) >= "2022-02-16" & ymd(`Admission Date (yyyy-mm-dd)`) <= "2022-03-31")  %>% 
  # left_join with table 1 data
  # select(`HN Number`, `Length of Stay`, death28d, daystilldeath) %>%
  left_join(ip_tab1_df, .)

# impute 28d death
ip_death_los = ip_death_los %>%
  mutate(death28d = ifelse(`Discharge Status`=="DEATH" & 
                             ymd(`Discharge Date (yyyy-mm-dd)`) - ymd(`Admission Date (yyyy-mm-dd)`) <= 28 &
                             !is.na(`Discharge Status`), 1, 0),
         daystilldeath = ymd(`Discharge Date (yyyy-mm-dd)`) - ymd(`Admission Date (yyyy-mm-dd)`),
         # right-censor
         daystilldeath = ifelse(daystilldeath > 28, 28, daystilldeath),
         # replace na with 0
         daystilldeath = ifelse(is.na(daystilldeath), 0, daystilldeath))
```

# table 1 propensity and IPTW by ipw/weightit

```{r}

# as.factor cateogorical cols and left_join ip_death_los data
ip_propensity = ip_tab1_df  %>%
  mutate(across(2:length(colnames(ip_tab1_df)), factor)) %>%
  left_join(select(ip_death_los, `HN Number`, death28d)) %>%
  select(-`Reference Key`, -`HN Number`, -`Admission Date (yyyy-mm-dd)`) %>%
  rename(age = `Admission Age (Year) (episode based)`) %>%
  # replace comorbs and meds stats cols NA with 0
  mutate_at(3:length(colnames(.)), ~replace_na(., 0)) %>%
  # drop sex and age NA
  drop_na()

# check if there is any NA, missing data
ip_propensity %>% filter_all((any_vars(is.na(.))))

# write to xlsx
writexl::write_xlsx(ip_propensity, path = "./ps_analysis_df.xlsx")

x_factors = colnames(ip_propensity)[! colnames(ip_propensity) %in% c("paxlovid", "death28d")]

# ipw
function_call<-paste0("weight <- ipwpoint(
    exposure = paxlovid ,
    family = \"binomial\",
    link = \"logit\",
    numerator =~ 1,
    trunc = 0.01,
    denominator =~ ",paste(x_factors, collapse = "+")," ,
    data = ip_propensity
  )")
  
# weightit 
function_call<-paste0("weight <- weightit(paxlovid ~ ",paste(x_factors, collapse = "+"), 
              "data = ip_propensity, method = \"ps\", 
              estimand = \"ATE\")"
              )
eval(parse(text = function_call))

univariate_ps_anlysis =  NULL
ps_anlysis = as.data.frame(c())
# exclude age
for(name in c("paxlovid", x_factors[x_factors != "age"])){
  print(name)
  clus <- svydesign(id =~ 1, weights = weight$weights.trunc, data = ip_propensity)
  res <- svyglm(paste0("death28d ~", name), design = clus,family = binomial)
  ps_holder = tidy(res, exponentiate = T, conf.int = T, conf.level = .95)
  ps_anlysis = bind_rows(ps_anlysis, ps_holder)
}
ps_anlysis = ps_anlysis %>% filter(term != "(Intercept)")
ps_anlysis
writexl::write_xlsx(ps_anlysis, path = "./ps_analysis.xlsx")
```

```{r}
# select only sex, age, obesity, diabetes, paxlovid and molnupiravir
ip_death_los = ip_death_los %>% 
  select(daystilldeath, death28d, Sex, `Admission Age (Year) (episode based)`, obesity, diabetes, paxlovid, molnupiravir)

# impute 65+
ip_death_los = ip_death_los %>%
  mutate(over64 = ifelse(`Admission Age (Year) (episode based)` >= 65, 1 , 0)) %>%
  select(-`Admission Age (Year) (episode based)`)
```

# table 2b descriptive 

```{r}

ip_2b = ip_death_los %>%
  select(over64, Sex, obesity, diabetes, paxlovid, molnupiravir) %>%
  mutate_all(factor)
ip_tab2b = CreateTableOne(data = ip_2b, strata = c("paxlovid"))
ip_tab2b
```

# (univariate) hazard ratio per predictor

```{r}
model = as.data.frame(c())
# iterate over cols
for(i in 3:length(ip_death_los)){
  x = colnames(ip_death_los)[i]
  iformula <- as.formula(sprintf("Surv(daystilldeath, death28d) ~ %s", x))
  coxfit_paxlovid <- coxph(formula = iformula, 
                data = ip_death_los)
  model = bind_rows(model, tidy(coxfit_paxlovid, exponentiate = T, conf.int = T, conf.level = .95))
}
model
```

# multivariate model

```{r}
coxfit_paxlovid <- coxph(formula = Surv(daystilldeath, death28d) ~ Sex+ over64+obesity+diabetes+paxlovid+molnupiravir, 
                data = ip_death_los)
tidy(coxfit_paxlovid, exponentiate = T, conf.int = T, conf.level = .95)
plot(survfit(coxfit_paxlovid))
```

# LOS

```{r}

ggplot(ip_death_los, aes(x = as.numeric(`Length of Stay`), fill = as.factor(paxlovid))) +
  geom_histogram()
```

