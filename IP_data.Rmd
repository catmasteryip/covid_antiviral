---
title: "R Notebook"

---

# import libraries

```{r}
library(survival)
library(broom)
library(survey)
library(comorbidity)
library(WeightIt)
library(cobalt)
library(tableone)
library(ggfortify)
library(dplyr)
library(tidyr)
source("./scripts/helper.R")
```


# 2022-04-26: episode death info is missing from hosp files; 
# please refer to data_import.Rmd for IP data import 
# check drug names (optional)

```{r}
unique(ip$`Drug Name`)[grepl("DEXAMETHASONE", unique(ip$`Drug Name`))]
```

# dissociate drug use and ip data (unique by HN number)

```{r}
# specify icd9 code column index
diag_cols = 35:49

ip.nodrug = ip %>%
  select(-`Drug Name`) %>%
  distinct() %>%
  # exclude pregnancy
  mutate(pregnancy = ifelse(if_any(diag_cols, ~between(., "630", "679.99")), T, F),
         pregnancy = ifelse(is.na(pregnancy), F, pregnancy)) %>%
  filter(!pregnancy) %>%
  select(-pregnancy)
```

# identification dataframe of IP patients' first admissions only (ip.id)

```{r}
ip.id = ip.nodrug %>%
  select(`Reference Key`, `HN Number`, `Admission Date (yyyy-mm-dd)`, `Discharge Date (yyyy-mm-dd)`) %>%
  group_by(`Reference Key`) %>%
  slice(which.min(ymd(`Admission Date (yyyy-mm-dd)`))) %>%
  ungroup()

writexl::write_xlsx(ip_first_by_patient_id, "./ip.id.xlsx")
```

# comorbs, change to comorbidity package (ip.diag)

```{r}
# specify icd9 code column index
diag_cols = 35:49

ip.diag = ip.nodrug %>% 
  select(`HN Number`, diag_cols) %>%
  impute_comorbs(., diag_cols - 33) 

ip.diag = aggregate(ip.diag, by = list(ip.diag[, "HN Number"]), FUN = "max") %>%
  select(-Group.1)

ip.charlson = ip.nodrug %>% 
  select(`HN Number`, diag_cols) %>%
  # filter(`HN Number` %in% ip_first_by_patient_id$`HN Number`) %>%
  pivot_longer(cols = diag_cols - 33 , names_to = "diagnosis", values_to = "code") %>%
  drop_na() %>%
  group_by(`HN Number`) %>%
  distinct() %>%
  ungroup() %>%
  mutate(id = 1:n())

# CCI
charlson = comorbidity::comorbidity(x = as.data.frame(ip.charlson), 
                                   id = "id", 
                                   code = "code", 
                                   map = "charlson_icd9_quan", 
                                   assign0 = F) 
# charlson comorbs and cci by HN Number
charlson = charlson %>%
  left_join(select(charlson_diag, `HN Number`, id))
charlson = aggregate(charlson, by = list(charlson[, "HN Number"]), FUN = "max") %>%
  select(-Group.1)
charlson = charlson %>% 
  rowwise() %>% 
  mutate(cci = sum(c_across(mi:aids))) %>%
  mutate(cci = case_when(
    cci == 0~ "0",
    cci < 3~ "1-2",
    cci < 5~ "3-4",
    cci >= 5~ "5+",
    TRUE ~ "0"
  ))
cci = charlson %>%
  select(`HN Number`, cci)
# writexl::write_xlsx(charlson_diag, path = "./charlson_diag.xlsx")


ip.diag = ip.diag %>%
  left_join(cci, by = "HN Number") %>%
  # replace_na of ci
  mutate(cci = ifelse(is.na(cci), "0", cci))
  # select(-diagnosis, -id, -code)
  
unique(ip_diag$cci)

# check if there is any NA, missing data
ip.diag %>% filter_all((any_vars(is.na(.))))  
writexl::write_xlsx(ip.diag, "./ip.diag.xlsx")
```

# OP meds status (deprecated, do not delete)

```{r}
# # ------------------------
# # combine with OP meds status (incomplete)
# # 1. match by reference key &
# # 2. appointment date <= (first) admission date
# medOPdf_shortlist = medOPdf %>%
#   left_join(ip_first_by_patient_id, by = "Reference Key") %>%
#   filter(ymd(`Appointment Date (yyyy-mm-dd)`) <= ymd(`Admission Date (yyyy-mm-dd)`)) %>%
#   select(c("Reference Key", "paxlovid", "aspirin", "ace_inhibitors", "beta_blockers", "calcium_channel_blockers", "statins", "molnupiravir"))
# 
# # combine with administration route info on dexamethasone form steroid
# medIPdf_shortlist = medIPdf %>%
#   left_join(ip_first_by_patient_id, by = "HN Number")
# 
# common_cols = intersect(colnames(medOPdf_shortlist), colnames(medIPdf_shortlist))
# medIOPdf = bind_rows(medOPdf_shortlist %>% select(common_cols), 
#                      medIPdf_shortlist %>% select(c(common_cols, "baricitinib")))

# # aggregate medIOPdf by reference key
# medIOPdf = medIOPdf %>%
#   # as.numeric binary cols
#   mutate_at(2:length(colnames(medIOPdf)), as.numeric)
# medIOPdf =
#   aggregate(medIOPdf, by = list(medIOPdf[, "Reference Key"]), FUN = "max") %>%
#   select(-Group.1) %>%
#   # left-join with dexamethasone meds status 
#   mutate(dexamethasone = ifelse(`Reference Key` %in% dexamethasone_idshortlist$`Reference Key`, 1, 0)) %>%
#   mutate_at(2:length(colnames(medIOPdf)), ~replace_na(., "0")) %>%
#   # as.factor binary cols
#   mutate_at(2:length(colnames(medIOPdf)), factor) 
#   
# 
# writexl::write_xlsx(medIOPdf, "./medIOPdf.xlsx")
```

# IP data joins

# table 1 descriptive/SMD

```{r}
# hhttps://cran.r-project.org/web/packages/tableone/vignettes/smd.html#:~:text=The%20standardized%20(mean)%20difference%20is,and%20after%20propensity%20score%20matching.

ip_tab1_df = df_ip %>%
  mutate(`Admission Age (Year) (episode based)` = as.numeric(`Admission Age (Year) (episode based)`),
         ) %>%
  select(`Reference Key`, `HN Number`,`Admission Date (yyyy-mm-dd)`,
         `Admission Age (Year) (episode based)`, Sex) %>%
  # first admissions only
  filter(`HN Number` %in% ip_first_by_patient_id$`HN Number`) %>%
  # left_join ip_diag to df_ip by HN Number
  left_join(ip_diag, by = "HN Number") %>%
  # left join IOP meds status 
  left_join(medIOPdf, by = "Reference Key") %>%
  # filter out sex and age NA
  filter(!is.na(Sex), !is.na(`Admission Age (Year) (episode based)`)) %>%
  # impute age groups
  mutate(
    age = as.numeric(`Admission Age (Year) (episode based)`),
    age_group = 1,
    age_group = case_when( 
      age < 65 ~ "under65",
      (age >= 65 & age < 75) ~ "65-74",
      age >= 75~"over74",
      TRUE ~ as.character(age_group)
    )) %>%
  select(-`Admission Age (Year) (episode based)`)

# # optional, left join IP meds data only 
# ip_tab1_df = ip_tab1_df %>%
#   left_join(medIPdf_shortlist)

# # check if there is any NA, missing data
# ip_tab1_df %>% filter_all((any_vars(is.na(.))))  

# write excel by patient data
writexl::write_xlsx(ip_tab1_dfholder, path = "./ip_df.xlsx")
```



```{r}

ip_tab1_dfholder = ip_tab1_df %>%
  select(-`Reference Key`, -`HN Number`, -`Admission Date (yyyy-mm-dd)`) %>%
  # replace na of comorbs cols
  mutate_at(2:(length(colnames(.))-2), ~replace_na(., 0)) %>%
  # remove NA in sex and age
  drop_na() %>%
  # numeric binary to factor cateogorical cols
  mutate(across(!age, factor)) %>%
  select(-age)
  

# check if there is any NA, missing data
ip_tab1_dfholder %>% filter_all((any_vars(is.na(.))))  


```

# 28d mortality and length of stay

```{r}
# subselect relevant cols
ip_death_los = df_ip %>%
  select(
         # keys
         `Reference Key`, `HN Number`, 
         # death information, death if discharge status == death, discharge date becomes death date
         `Admission Date (yyyy-mm-dd)`, `Discharge Date (yyyy-mm-dd)`,  `Discharge Status`, 
         # length of stay LOS in days
         `Length of Stay`
         ) %>%
  filter(ymd(`Admission Date (yyyy-mm-dd)`) >= "2022-02-16" & ymd(`Admission Date (yyyy-mm-dd)`) <= "2022-03-31")  

# impute 28d death
ip_death_los = ip_death_los %>%
  mutate(death28d = case_when(
    `Discharge Status`=="DEATH" & 
      ymd(`Discharge Date (yyyy-mm-dd)`) - ymd(`Admission Date (yyyy-mm-dd)`) <= 28 &
      !is.na(`Discharge Status`)~1, 
      # unknown discharge status, unknown death28d status -> survival
      is.na(`Discharge Status`)~0,
      TRUE~0
    ),
     daystilldeath = ymd(`Discharge Date (yyyy-mm-dd)`) - ymd(`Admission Date (yyyy-mm-dd)`),
     # right-censor
     daystilldeath = ifelse(daystilldeath > 28 & death28d == 0, 28, daystilldeath),
     death28d = ifelse(daystilldeath > 28 & death28d == 1, 0, death28d), 
     # replace na with 28
     daystilldeath = ifelse(is.na(daystilldeath), 28, daystilldeath))
# colnames(ip_death_los)
writexl::write_xlsx(ip_death_los, './ip_death_los.xlsx')
```






# table 2b descriptive 

```{r}
# select only sex, age, obesity, diabetes, paxlovid and molnupiravir
ip_2b = ip_tab1_df  %>%
  select(`HN Number`, age_group, Sex, obesity, diabetes, molnupiravir, paxlovid) %>%
  # replace daystilldexa NA, impute dexamethasone, factorise
  mutate(age_group = ifelse(age_group != "under65", "65plus", age_group)) %>%
  # left-join death data
  left_join(select(ip_death_los, `HN Number`, death28d, daystilldeath)) %>%
  mutate(across(2:length(colnames(.)), factor)) %>%
  select(-`HN Number`) 

ip_tab2b = CreateTableOne(data = select(ip_2b, -daystilldeath), strata = c("paxlovid"), test = F)
print(ip_tab2b, smd = T)
```

# death28d HR (2b)

```{r}
death_shortlist = ip_death_los %>%
  select(`HN Number`, `death28d`, `daystilldeath`) %>%
  rename(timetoevent = daystilldeath,
         event = death28d)
results_death = calculate_hr(df = ip_tab1_df,
             eventdata = death_shortlist)
results_death
surv_death = results_death[[3]]
table_hr = results_dexa[[1]]
table_hr
# writexl::write_xlsx(surv_death, "./intermediates/surv_death.xlsx")

# death28d KM estimation of entire pop.
death.fit = survival::survfit(Surv(as.numeric(timetoevent), as.numeric(event), type = "right") ~ paxlovid, 
                           data = surv_death)

autoplot(death.fit, ylim = c(0, 1))

```

# COVID antiviral HR (optional)

```{r}
# dexamethasone
dexamethasone_shortlist = dexamethasone_shortlist %>%
  rename(timetoevent = daystilldexa)
results_dexa = calculate_hr(df = ip_tab1_df,
             eventdata = dexamethasone_shortlist)

ip_dexamethasone = results_dexa[[3]]
writexl::write_xlsx(ip_dexamethasone, "./intermediates/ip_dexamethasone.xlsx")


# baricitinib
baricitinib_shortlist = baricitinib_shortlist %>%
  rename(timetoevent = daystillbari)
results_bari = calculate_hr(df = ip_tab1_df,
             eventdata = baricitinib_shortlist)
results_bari
```

# Both COVID antiviral HR 

```{r}
# dexamethasone or baricitinib
dexabari_shortlist = bind_rows(dexamethasone_shortlist,baricitinib_shortlist)
dexabari_shortlist = aggregate(.~`HN Number`, dexabari_shortlist, min)
results_dexabari = calculate_hr(df = ip_tab1_df,
             eventdata = dexabari_shortlist)
results_dexabari
surv_dexabari = results_dexabari[[3]]
writexl::write_xlsx(surv_dexabari, "./intermediates/surv_dexabari.xlsx")

# covid antiviral prescription KM estimation of entire pop.
dexabari.fit = survival::survfit(Surv(as.numeric(timetoevent), as.numeric(event), type = "right") ~ paxlovid, 
                           data = surv_dexabari)

autoplot(dexabari.fit, ylim=c(0,1))
```

# ICU HR

```{r}
icu = icu %>%
  rename(timetoevent = daystillicu)
results_icu = calculate_hr(df = ip_tab1_df,
             eventdata = icu)
results_icu
surv_icu = results_icu[[3]]
writexl::write_xlsx(surv_icu, "./intermediates/surv_icu.xlsx")

# ICU KM estimation of entire pop.
prio.fit = survival::survfit(Surv(as.numeric(timetoevent), as.numeric(event), type = "right") ~ paxlovid, 
                           data = surv_icu)

autoplot(prio.fit)
```

# IPTW KM analysis

```{r}
# death28d KM estimation of entire pop.
weighted.death.fit = survival::survfit(Surv(as.numeric(timetoevent), as.numeric(event), type = "right") ~ paxlovid, 
                           data = surv_death,
                           weights = weight$weights)

autoplot(weighted.death.fit, ylim = c(0,1))

# dexabari KM estimation of entire pop.
weighted.dexabari.fit = survival::survfit(Surv(as.numeric(timetoevent), as.numeric(event), type = "right") ~ paxlovid, 
                           data = surv_dexabari,
                           weights = weight$weights)

autoplot(weighted.dexabari.fit, ylim = c(0,1))

# dexabari KM estimation of entire pop.
weighted.icu.fit = survival::survfit(Surv(as.numeric(timetoevent), as.numeric(event), type = "right") ~ paxlovid, 
                           data = surv_icu,
                           weights = weight$weights)

autoplot(weighted.icu.fit)

```

