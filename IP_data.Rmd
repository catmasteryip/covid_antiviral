---
title: "R Notebook"
output: html_notebook
---

# 2022-04-26: episode death info is missing from hosp files
# age and sex

```{r}


df = ip
# # ignore paxlovid / paxlovid renal impairment difference
# # ignore different types of MOLNUPIRAVIR difference
# df = df %>%
#   mutate(`Drug Name` = ifelse(grepl("MOLNUPIRAVIR", `Drug Name`), "MOLNUPIRAVIR", `Drug Name`),
#          `Drug Name` = ifelse(grepl("PAXLOVID", `Drug Name`), "PAXLOVID", `Drug Name`),
#          `Drug Name` = ifelse(is.na(`Drug Name`), "None", `Drug Name`)) %>%
#   filter(`Drug Name` != "MOLNUPIRAVIR") 
```

# check drug names

```{r}
unique(df$`Drug Name`)[grepl("INHIBITOR", unique(df$`Drug Name`))]
```

# dissociate drug use and ip data (unique by HN number)

```{r}
df_drug_use = df %>% 
  select(`HN Number`, `Drug Name`)
df_ip = df %>%
  select(-`Drug Name`) %>%
  distinct()
medHNlist = 
  df_drug_use %>%
  # case-sensitive imputation of drug names
  mutate(
         # paxlovid
         paxlovid = ifelse(grepl("PAXLOVID", `Drug Name`), 1, 0),
         # aspirin
         aspirin = ifelse(grepl("ASPIRIN|ACETYLSALICYLIC ACID", `Drug Name`), 1, 0),
         # ACE inhibitors
         ace_inhibitors = ifelse(grepl("BENAZEPRIL|CAPTOPRIL|CLIZAPRIL|ENALAPRIL|ENALAPRILAT|FOSINOPRIL|LISINOPRIL|MOEXIPRIL|PERINDOPRIL|QUINAPRIL|RAMIPRIL|TRANDOLAPRIL", `Drug Name`), 1, 0),
         # beta blockers
         beta_blockers = ifelse(grepl("ACEBUTALOL|ATENOLOL|BETAXOLOL|BISOPROLOL|CARTEOLOL|CARVEDILOL|ESMOLOL|LABETALOL|LEVOBUNOLOL|METOPROLOL|NADOLOL|NEBIVOLOL|PINDOLOL|PROPANOLOL|SOTALOL|TIMOLOL", `Drug Name`), 1, 0),
         # calcium channel blockers
         calcium_channel_blockers = ifelse(grepl("AMLODIPINE|CLEVIDIPINE|FELODIPINE|FLUNARZINE|ISRADIPINE|LEVAMLODIPINE|NICARDIPINE|NIFEDIPINE", `Drug Name`), 1, 0),
         # statins
         statins = ifelse(grepl("ATORVASTATIN|SIMVASTATIN|FLUVASTATIN|LOVASTATIN|PITAVASTATIN|PRAVASTATIN|ROSUVASTATIN", `Drug Name`), 1, 0),
         # molnupiravir
         molnupiravir = ifelse(grepl("MOLNUPIRAVIR", `Drug Name`), 1, 0)
         ) %>%
  select(-`Drug Name`)

# compress binary drug use columns by HN number
# aggregate by HN Number, get 1 if possible
medHNlist = aggregate(medHNlist, by = list(medHNlist[, "HN Number"]), FUN = "max")

df_ip = df_ip %>% 
  left_join(medHNlist, by = "HN Number")
```

# comorbs

```{r}
# specify icd9 code column index
diag_cols = 35:49

df_diag = df %>% 
  select(`HN Number`, diag_cols)

diag_cols = diag_cols - 33 
df_diag = df_diag %>%
  mutate(
  diabetes = ifelse(if_any(diag_cols, ~grepl("^250", .)), 1, 0),
  hypertension = ifelse(if_any(diag_cols, 
                            ~between(., "401", "405.99")), 1, 0),
  stroke = ifelse(if_any(diag_cols, 
                      ~(between(., "362.3", "362.49") |
                        between(., "430", "435.99"))), 1, 0),
  heart_failure = ifelse(if_any(diag_cols, ~grepl("^428", .)), 1, 0),
  # atrial fibrillation
  atrial_fib = ifelse(if_any(diag_cols, ~grepl("^427.31", .)), 1, 0),
  parkinsons = ifelse(if_any(diag_cols, ~grepl("^332.00", .)), 1, 0),
  # schizophrenia
  schizo = ifelse(if_any(diag_cols, ~grepl("^295", .)), 1, 0),
  # liver cirrhosis
  liver = ifelse(if_any(diag_cols, 
                     ~(grepl("^571.5|^517.2|^546|^567.89|^789.59", .) |
                     between(., "456", "456.21") |
                     between(., "567", "567.21") |
                     between(., "572.2", "572.49"))), 1, 0),
  # depression
  depression = ifelse(if_any(diag_cols, 
                    ~( grepl("^300.4|^269.5", .) |
                     between(., "269.2", "260.39") |
                     between(., "309", "311"))), 1, 0),
  # chronic kidney disease
  ckd = ifelse(if_any(diag_cols, 
                     ~(grepl("^593.9|^592", .) |
                     between(., "583", "586.99"))), 1, 0),
  # rheumatoid arthritis
  arthritis = ifelse(if_any(diag_cols, 
                         ~(grepl(., "^446.5|^725") |
                         between(., "714", "714.29") |
                         between(., "714.8", "718.89")))
                         , 1, 0),
  # obesity
  obesity =  ifelse(if_any(diag_cols, 
                     ~between(., "277.70", "280.09")), 1, 0),
  # alcohol abuse
  alcohol_abuse = ifelse(if_any(diag_cols, 
                             ~grepl("^303|^305", .)), 1, 0),
  
)
# specify binary comorbity column index
comorb_cols = 1:12 + max(diag_cols)
# replace NA as 0
df_diag = df_diag %>% 
  mutate_at(comorb_cols, ~replace_na(., 0))
# remove icd codes from df_diag
df_diag = df_diag %>%
  select(-diag_cols)

```

# table 1 SMD

```{r}
# hhttps://cran.r-project.org/web/packages/tableone/vignettes/smd.html#:~:text=The%20standardized%20(mean)%20difference%20is,and%20after%20propensity%20score%20matching.
library(tableone)
df_tab1 = df_ip %>%
  mutate(`Admission Age (Year) (episode based)` = as.numeric(`Admission Age (Year) (episode based)`),
         ) %>%
  select(`Reference Key`,
         `HN Number`,
         `Admission Age (Year) (episode based)`,
         Sex,
         # drug use
         paxlovid, aspirin, ace_inhibitors, beta_blockers, calcium_channel_blockers, statins, molnupiravir)

# left_join df_diag to df_ip by HN Number
df_tab1 = df_tab1 %>%
  left_join(., df_diag, by = "HN Number") %>%
  # deselect HN Number
  select(-`HN Number`)

# aggregate binary columns by reference key
df_tab1 = aggregate(df_tab1, by = list(df_tab1[, "Reference Key"]), FUN = "max") %>%
  select(-Group.1, -`Reference Key`)

df_tab1 = df_tab1 %>%
  mutate(across(2:length(colnames(df_tab1)), factor))

tab1 = CreateTableOne(data = df_tab1, strata = "paxlovid")
tab1
# smd_1 = CreateTableOne(data = df_tab1, strata = "paxlovid",  smd = T)
# smd_1
# smd_2 = CreateTableOne(data = df_tab1, strata = "molnupiravir",  smd = T)
# smd_2
```


