---
title: "R Notebook"
output: html_notebook
---

# import libraries

```{r}
library(here)
library(dplyr)
library(tidyr)
library(readxl)
library(lubridate)
library(ggplot2)
```

# read 5th-wave data

```{r}
read_xlsx_from_folder = function(filepath, match_by = NULL){
  filenames = list.files(filepath)
  # browser()
  filenames = filenames[grepl(match_by, filenames)]
  df = as.data.frame(c())
  for(name in filenames){
    xlsx = readxl::read_xlsx(paste0(filepath, name), col_types = "text")
    df = bind_rows(df, xlsx)
  }
  df
}
# # antiviral use 
# drug_use = read_xlsx_from_folder("./data/5th Wave 202202/Antiviral/", ".xlsx")
# steroid administration route data
# directory as in onelook drive: ~/COVID Database/Patient-based Record/XLSX (Preferred)/Wave 5/Steroid
steroid = read_xlsx_from_folder("./data/Wave 5/Steroid/", "_DRG.xlsx")

# reference key data
dx = read_xlsx_from_folder("./data/5th Wave 202202/Dx/", "_DX.xlsx")
# COVID patients AE data
ae = read_xlsx_from_folder("./data/5th Wave 202202/Dx/", "_AE.xlsx")

# COVID patients IP data, which contains sex, age, icd9 diagnosis, drug use, death and length of stay data
options(warn = -1)
# directory as in onelook drive: ~/COVID Database/Patient-based Record/XLSX (Preferred)/Wave 5
ip2 = read_xlsx_from_folder("./data/Wave 5/A&E and Hospitalization/202202/Dx/", "_IP.xlsx")
ip3 = read_xlsx_from_folder("./data/Wave 5/A&E and Hospitalization/202203/Dx/", "_IP.xlsx")
ip = bind_rows(ip2, ip3)
ip2 = ip3 = NULL
# filter only wave 5, ie 16th feb - 31st mar
ip = ip %>% 
  filter(ymd(`Admission Date (yyyy-mm-dd)`) >= "2022-02-16")

# COVID patients OP data
# directory as in onelook drive: ~/COVID Database/Patient-based Record/Designated Clinic
op_drug = read_xlsx_from_folder("./data/Designated Clinic/drug/", ".xlsx")
op_drug = op_drug %>%
  filter(ymd(`Appointment Date (yyyy-mm-dd)`) >= "2022-02-16" & ymd(`Appointment Date (yyyy-mm-dd)`) <= "2022-03-31")
  
op = read_xlsx_from_folder("./data/Designated Clinic/no_frills/", ".xlsx")
op = op %>%
  filter(ymd(`Appointment Date (yyyy-mm-dd)`) >= "2022-02-16" & ymd(`Appointment Date (yyyy-mm-dd)`) <= "2022-03-31")

# demo IP data
demo_ip = read_xlsx_from_folder("./data/5th Wave 202202/", "_demo_IP.xlsx")
```

# look for antiviral data

```{r}
drug_use$`Drug Item Code`
unique(drug_use$`Drug Name`)
unique(drug_use$`Drug Name`)[grepl("DEXAMETHASONE", unique(drug_use$`Drug Name`))]
```


# get all covid patients age, sex, drug use (or lack thereof)

```{r}
# id of patients who had > 1 type antiviral
id_over1_type_antiviral = drug_use %>% 
  select(`Reference Key`, `Dispensing Date (yyyy-mm-dd)`, `Drug Name`) %>% 
  group_by(`Reference Key`) %>%
  distinct(`Drug Name`) %>%
  count(`Reference Key`) %>%
  ungroup() %>%
  filter(n > 1) %>% 
  pull(`Reference Key`)
drug_use_shortlist = drug_use %>% 
  select(`Reference Key`, `Prescription Start Date`, `Prescription End Date`, `Drug Name`) %>%
  group_by(`Reference Key`, `Drug Name`) %>%
  summarise(`Prescription Start Date` = first(`Prescription Start Date`),
            `Drug Name` = first(`Drug Name`))
```




