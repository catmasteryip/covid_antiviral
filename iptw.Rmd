---
title: "R Notebook"
output: html_notebook
---

# propensity and IPTW by weightit

```{r}
# as.factor cateogorical cols and left_join ip_death_los data
ip_propensity = ip_tab1_df  %>%
  select(-age) %>%
  # left-join death data
  left_join(select(ip_death_los, `HN Number`, death28d)) %>%
  mutate(across(2:length(colnames(ip_tab1_df)), factor)) %>%
  select(-`Reference Key`, -`HN Number`, -`Admission Date (yyyy-mm-dd)`)  %>%
  # replace comorbs, meds stats and death28d cols NA with 0
  mutate(across(c(diabetes:dexamethasone, death28d), ~replace_na(., 0))) %>%
  # drop sex NA
  drop_na() 
  

# check if there is any NA, missing data
ip_propensity %>% filter_all((any_vars(is.na(.))))
# write to xlsx
# writexl::write_xlsx(ip_propensity, path = "./ps_analysis_v5.xlsx")

ip_propensity = ip_propensity %>%
  select(-dexamethasone, -baricitinib)
ip_tab1_p = CreateTableOne(data = ip_propensity, strata = "paxlovid", test = F)
# print(ip_tab1_p)

ip_tab1_p_Mat <- print(ip_tab1_p, quote = FALSE, noSpaces = TRUE, printToggle = FALSE, smd = T)
ip_tab1_p_Mat = as.data.frame(cbind(" " = rownames(ip_tab1_p_Mat),ip_tab1_p_Mat))
## Save to a xlsx
writexl::write_xlsx(ip_tab1_p_Mat, path = "./tableonep.xlsx")

ip_tab1_m = CreateTableOne(data = ip_propensity, strata = "molnupiravir", test = F)
# print(ip_tab1_m, smd = T)
ip_tab1_m_Mat <- print(ip_tab1_m, quote = FALSE, noSpaces = TRUE, printToggle = FALSE, smd = T)
ip_tab1_m_Mat = as.data.frame(cbind(" " = rownames(ip_tab1_m_Mat),ip_tab1_m_Mat))
## Save to a xlsx
writexl::write_xlsx(ip_tab1_m_Mat, path = "./tableone_m.xlsx")
```

# propensity iptw paxvlovid, ATT

```{r}
x_factors = colnames(ip_propensity)

x_factors = x_factors[! x_factors %in% c("paxlovid", "death28d", "baricitinib", "dexamethasone", "parkinsons")]
clus = iptw_tableone(df = ip_propensity, 
              treatment = "paxlovid",
              x_factors = x_factors,
              path_of_unweighted_tableone = "./p.unweighted.tableone.xlsx",
              path_of_weighted_tableone = "./p.weighted.tableone.xlsx")
```

# ATT of death28d as outcome

```{r}
clus <- svydesign(id =~ 1, weights = weight$weights, data = ip_propensity)
res <- svyglm(death28d ~ paxlovid, design = clus,family = binomial)
ps_holder = tidy(res, exponentiate = T, conf.int = T, conf.level = .95)
ps_holder %>% filter(term != "(Intercept)")
```




