---
title: "R Notebook"

---

# propensity and IPTW by weightit

```{r}

ip.iptw = ip.id %>%
  left_join(ip.sexage) %>% 
  filter(!is.na(Sex) | !is.na(age)) %>%
  left_join(ip.drug.all) %>%
  left_join(ip.diag) 
  # as.factor cateogorical cols
x_factors = colnames(ip.iptw)
x_factors = x_factors[!x_factors %in% c("Reference Key","HN Number",
                                        "Admission Date (yyyy-mm-dd)","Discharge Date (yyyy-mm-dd)",
                                        "age","paxlovid","molnupiravir", "dexamethasone", "baricitinib", "parkinsons")]
trt_factors = c("paxlovid","molnupiravir")
ip.iptw = ip.iptw %>%
  mutate(across(c(x_factors, trt_factors), ~replace_na(., 0))) %>%
  mutate(across(c(x_factors, trt_factors), factor))

# check if there is any NA, missing data
ip.iptw %>% filter(across(c(x_factors, trt_factors), is.na))
# write to xlsx
# writexl::write_xlsx(ip_propensity, path = "./ps_analysis_v5.xlsx")

ip.tab1.p = CreateTableOne(data = select(ip.iptw, x_factors, paxlovid), strata = "paxlovid", test = F)
print(ip.tab1.p, smd = T)

# ip.tab1.p.Mat <- print(ip.tab1.p, quote = FALSE, noSpaces = TRUE, printToggle = FALSE, smd = T)
# ip.tab1.p.Mat = as.data.frame(cbind(" " = rownames(ip.tab1.p.Mat),ip.tab1.p.Mat))
## Save to a xlsx
# writexl::write_xlsx(ip_tab1_p_Mat, path = "./ip.tab1.p.xlsx")
# 
ip.tab1.m = CreateTableOne(data = select(ip.iptw, x_factors, molnupiravir), strata = "molnupiravir", test = F)
print(ip.tab1.m, smd = T)
# ip_tab1_m_Mat <- print(ip_tab1_m, quote = FALSE, noSpaces = TRUE, printToggle = FALSE, smd = T)
# ip_tab1_m_Mat = as.data.frame(cbind(" " = rownames(ip_tab1_m_Mat),ip_tab1_m_Mat))
# ## Save to a xlsx
# writexl::write_xlsx(ip_tab1_m_Mat, path = "./tableone_m.xlsx")
```

# propensity iptw paxvlovid, ATT

```{r}
x_factors = colnames(ip_propensity)

x_factors = x_factors[! x_factors %in% c("paxlovid", "death28d", "baricitinib", "dexamethasone", "parkinsons")]
clus = iptw_tableone(df = ip_propensity, 
              treatment = "paxlovid",
              x_factors = x_factors,
              path_of_unweighted_tableone = "./p.unweighted.tableone.xlsx",
              path_of_weighted_tableone = "./p.weighted.tableone.xlsx")
weights = clus
result = iptw_regression_tidy(df = ip_propensity, 
                     weight = weights, 
                     outcome = "death28d",
                     treatment = "paxlovid")
result
```

# ATT of death28d as outcome

```{r}
clus <- svydesign(id =~ 1, weights = weight$weights, data = ip_propensity)
res <- svyglm(death28d ~ paxlovid, design = clus,family = binomial)
ps_holder = tidy(res, exponentiate = T, conf.int = T, conf.level = .95)
ps_holder %>% filter(term != "(Intercept)")
```




