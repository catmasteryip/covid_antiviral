---
title: "R Notebook"

---

# import libraries

```{r}
library(forestplot)
library(ggfortify)
```

# propensity and IPTW by weightit

```{r}
ip.iptw = ip.id %>%
  left_join(ip.sexage) %>%
  filter(!is.na(Sex) | !is.na(age)) %>%
  left_join(ip.sdi) %>%
  filter(!is.na(sdi_q)) %>%
  left_join(ip.drug.all) %>%
  left_join(ip.diag)

ip.iptw = ip.iptw %>% 
  # left join paxlovid
  left_join(ip.paxlovid) %>% 
  # impute paxlovid without 4d rule
  # impute paxlovid with 4d rule
  mutate(paxlovidlong = ifelse(!is.na(daystillpaxlovid), 1, 0),
         paxlovidshort = ifelse(daystillpaxlovid <= 4, 1, 0)) %>%
  # left join molnupiravir
  left_join(ip.molnupiravir) %>%
  # impute molnupiravir without 4d rule
  # impute molnupiravir with 4d rule
  mutate(molnupiravirlong = ifelse(!is.na(daystillmolnupiravir), 1, 0),
         molnupiravirshort = ifelse(daystillmolnupiravir <= 4, 1, 0)) 

# subset factors
x_factors_tableone = colnames(ip.iptw)
x_factors_tableone = x_factors_tableone[!x_factors_tableone %in% c("Reference Key","HN Number",
                                        "Admission Date (yyyy-mm-dd)","Discharge Date (yyyy-mm-dd)",
                                        "age_grp5", "dexamethasone", "baricitinib", "parkinsons", "district")]
x_factors_tableone = x_factors_tableone[!grepl("paxlovid|molnupiravir", x_factors_tableone)]
x_factors = x_factors_tableone[x_factors_tableone != "age"]

# trt_factors = c("paxlovid","molnupiravir")

# # check if there is any NA, missing data
# ip.iptw %>% filter(across(c("Sex"), is.na))

ip.iptw = ip.iptw %>%
  mutate(across(c(x_factors), ~replace_na(., 0)),
         across(c(x_factors) & !"age", factor)) 

# check if there is any NA, missing data
ip.iptw %>% filter(across(x_factors, is.na))
```

# 2 cohorts

```{r}
ip.iptw.p = ip.iptw %>%
  # remove all molnupiravir
  filter(molnupiravirlong != 1) %>%
  # remove all taken paxlovid only after 4d since admission
  filter(!(paxlovidlong == 1 & paxlovidshort != 1)) %>%
  mutate(paxlovid = ifelse(is.na(paxlovidshort), 0, 1)) %>%
  select(-contains("long"), -contains("short"), -contains("days"))

ip.iptw.m = ip.iptw %>%
  # remove all paxlovid
  filter(paxlovidlong != 1) %>%
  # remove all taken molnupiravir only after 4d since admission
  filter(!(molnupiravirlong == 1 & molnupiravirshort != 1))%>%
  mutate(molnupiravir = ifelse(is.na(molnupiravirshort), 0, 1))%>%
  select(-contains("long"), -contains("short"), -contains("days"))

# optional
# -----------
ip.tab1.p = CreateTableOne(vars = x_factors_tableone,
                           data = ip.iptw.p, 
                           strata = "paxlovid", test = F)
print(ip.tab1.p, smd = T)


ip.tab1.m = CreateTableOne(vars = x_factors_tableone,
                           data = ip.iptw.m, 
                           strata = "molnupiravir", test = F)
print(ip.tab1.m, smd = T)

# ip.tab1.death = CreateTableOne(data = ip.iptw %>%
#                                  left_join(ip.death) %>%
#                                  
#                              filter(!(paxlovid == 1 & molnupiravir == 1)) %>%
#                              select(x_factors, molnupiravir, paxlovid, death28d), 
#                            strata = "death28d", test = F)
# print(ip.tab1.death, smd = T)

```

# iptw paxvlovid, ATT

```{r}
# paxlovid (deprecated)
# --------------------
# ip.iptw.p = ip.iptw.p  %>%
#   # select(`Reference Key`, x_factors, molnupiravir, paxlovid) %>%
#   left_join(ip.death, by = 'Reference Key') %>%
#   # replace NA
#   mutate(across(!"daystillevent", ~replace_na(., 0)),
#          # factorise everything
#          across(!"daystillevent" & !"age", factor)) %>%
#   filter(molnupiravir != 1)
# 
# ip.iptw.p %>% filter(across(everything(), is.na))
# --------------------

weights.p = iptw_tableone(df = ip.iptw.p, 
              treatment = "paxlovid",
              x_factors = x_factors,
              x_factors_tableone = x_factors_tableone,
              path_of_unweighted_tableone = "./p.unweighted.tableone.xlsx",
              path_of_weighted_tableone = "./p.weighted.tableone.xlsx")

ip.iptw.p = ip.iptw.p %>%
  mutate(weight = weights.p$weights)

writexl::write_xlsx(ip.iptw.p, "./ip.iptw.p.nooutcome.xlsx")
```


```{r}
# molnupiravir (deprecated)
# --------------------
# 
# ip.iptw.m %>% filter(across(everything(), is.na))
# --------------------

weights.m = iptw_tableone(df = ip.iptw.m, 
              treatment = "molnupiravir",
              x_factors = x_factors,
              x_factors_tableone = x_factors_tableone,
              path_of_unweighted_tableone = "./m.unweighted.tableone.xlsx",
              path_of_weighted_tableone = "./m.weighted.tableone.xlsx")

ip.iptw.m = ip.iptw.m %>%
  mutate(weight = weights.m$weights)
```

# HR mortality


```{r}
x_factors_hr = c("Sex", "age_grp5", "sdi_q", "diabetes", "cancer")
# x_factors_hr2 = c("Sex", "age_grp3", "sdi_q", "diabetes", "cancer")
```

# paxlovid

```{r}
ip.iptw.p.mortality = ip.iptw.p  %>%
  left_join(ip.death, by = 'Reference Key') %>%
  # replace NA
  mutate(across(!"daystillevent", ~replace_na(., 0)),
         # factorise everything
         across(!"daystillevent" & !"age" & !"weight", factor))

writexl::write_xlsx(ip.iptw.p.mortality, "./ip.iptw.p.mortality.xlsx")

for(event in c("death28d", "resp_death")){
  hr.death = c()
  hr.death = iptw_hr_tidy(df = ip.iptw.p.mortality,
                          x_factors = x_factors_hr,
                          event = event,
                          daystillevent = "daystillevent",
                          treatment = "paxlovid")
  hr.death
  writexl::write_xlsx(hr.death, path = paste0("./hr.", event, ".agr_grp5.p.xlsx"))
}
```

# KM approx

```{r}
#KM curve : count time from day 0 
survfit(Surv(time = daystillevent,event = as.numeric(death28d))~ paxlovid,  
        weights = weights.p$weights, 
        data = ip.iptw.p.mortality, 
        ctype = 2)-> s_original
summary(s_original)

# KM plot
autoplot(s_original)

# fit the Cox model_original 
coxph(Surv(time =daystillevent, event = as.numeric(death28d))~ paxlovid , 
      weights = weights.p$weights, 
      data = ip.iptw.p.mortality, 
      id = `Reference Key`)-> Coxph_model_paxlovid_original
# exp(coef)== 0.1913

autoplot(Coxph_model_paxlovid_original)

# test the model if the proportionality assumption holds
cox.zph(Coxph_model_paxlovid_original)-> Test1
Test1
```

# HR organ dysfunction

```{r}
ip.iptw.p.organ_dys = ip.iptw.p %>%
  left_join(organ_dys) %>%
  # repalce NA with 0 
  mutate(across("Circulatory.shock":"Acute.liver.impairment", ~replace_na(., 0)))

# writexl::write_xlsx(ip.iptw.p.organ_dys, "./ip.iptw.p.organ_dys.xlsx")

for(event in c("Circulatory.shock","Respiratory.failure","Acute.kidney.injury","Coagulopathy","Acute.liver.impairment")){
  hr.death = c()
  # make days till event col
  ip.iptw.p.organ_dys = ip.iptw.p.organ_dys %>% 
    mutate(daystillevent = ifelse(!is.na(min_date) & event == 1, 
                                  ymd(min_date) - ymd(`Admission Date (yyyy-mm-dd)`),
                                  21),
           # right-censor
           daystillevent = ifelse(daystillevent > 21, 21, daystillevent))
  hr.death = iptw_hr_tidy(df = ip.iptw.p.organ_dys,
                          x_factors = x_factors_hr,
                          event = event,
                          daystillevent = daystillevent,
                          treatment = "paxlovid")
  hr.death
  writexl::write_xlsx(hr.death, path = paste0("./hr.", event, ".agr_grp5.p.xlsx"))
}
```


# molnupiravir

```{r}
for(event in c("death28d", "resp_death")){
  hr.death = c()
  hr.death = iptw_hr_tidy(df = ip.iptw.m,
                          x_factors = x_factors_hr,
                          event = event,
                          daystillevent = "daystillevent",
                          treatment = "molnupiravir")
  hr.death
  writexl::write_xlsx(hr.death, path = paste0("./hr.", event, ".agr_grp3.m.xlsx"))
}
```



